# Клац (macOS)

Клац — menu bar приложение для macOS, которое имитирует звуки механической клавиатуры при глобальном вводе.
Проект является самостоятельным и не аффилирован с другими приложениями с похожим назначением.

## Навигация README
- [Возможности](#возможности)
- [Функционал и примеры](#функционал-и-примеры)
- [Требования](#требования)
- [Быстрый старт](#быстрый-старт-из-исходников)
- [Сборка и установка .app](#сборка-и-установка-app)
- [Права macOS](#права-macos)
- [Если доступы сломались](#если-доступы-сломались)
- [Релизы в GitHub](#релизы-в-github)

## Возможности
- Глобальный перехват `keyDown/keyUp` через `CGEventTap`.
- Fallback на `NSEvent` global monitor, если `CGEventTap` недоступен.
- Профили свитчей на реальных `wav/mp3` сэмплах + встроенные Mechvibes-паки.
- Раздельные уровни звука: `Громкость`, `Нажатие`, `Отпускание`, `Space/Enter`, `Вариативность`.
- Автокомпенсация громкости относительно системного volume.
- Адаптация громкости к скорости печати (`CPS/WPM`) с авто-бейзлайном.
- `Stack-режим` с настройкой плотности для плотного клик-слоя на быстрой печати.
- Лимитер пиков с регулируемым драйвом.
- A/B сравнение (OFF/ON) для `Компенсация`, `Адаптация`, `Лимитер`, `Компенсация + Лимитер`.
- Live-индикаторы коэффициентов компенсации и адаптации.
- Тема интерфейса: `Системная / Светлая / Темная`.
- Режим меню-бара с компактным popover.
- Автозапуск при входе в систему.

## Функционал и примеры

### Быстрые настройки (главное окно)
- `Проверить` — повторно проверяет доступы.
- `Восстановить` — сбрасывает privacy-разрешения, открывает `Универсальный доступ` и `Мониторинг ввода`, затем перезапускает приложение.
- `Профиль` — выбор набора звуков свитчей.
- Строка статуса показывает отдельно: `Доступность` и `Мониторинг ввода`.

### Расширенные настройки (шестеренка)
- `Автокомпенсация` + `Сила компенсации`:
  - полезно, если системная громкость обычно низкая;
  - смотри индикатор `Текущая компенсация: x...`.
- `Адаптация к скорости печати`:
  - при быстром наборе звук автоматически усиливается относительно твоего базового темпа;
  - смотри индикатор `Адаптация авто: x... · ... CPS`.
- `Stack-режим` + `Плотность стака`:
  - `0%` — почти без стакинга, больше хвостов отпускания;
  - `100%` — плотный ударный слой с подавлением хвостов `keyUp`.
- `Лимитер пиков` + `Драйв лимитера`:
  - сглаживает резкие пики и защищает от неприятных всплесков.
- `A/B сравнение`:
  - выбери функцию (`Компенсация`, `Адаптация`, `Лимитер`);
  - нажми `Сравнить OFF/ON` для двух последовательных тестов.

### Встроенные sound packs
- `Kalih Box White`
- `Mechvibes: Gateron Browns - Revolt`
- `Mechvibes: HyperX Aqua`
- `Mechvibes: Box Jade`
- `Mechvibes: Opera GX`

## Требования
- macOS 13+
- Xcode Command Line Tools (`xcode-select --install`)
- Swift 5.9+

## Быстрый старт (из исходников)
```bash
cd "/path/to/project"
swift build
swift run
```

## Сборка и установка `.app`
```bash
cd "/path/to/project"
./scripts/build_app.sh --install
```

Итоговая сборка:
- локальный артефакт: `dist/*.app`
- установленная копия: `/Applications/Klac.app`

## Права macOS
Для корректного глобального перехвата клавиш нужны оба доступа:
- `Privacy & Security -> Accessibility`
- `Privacy & Security -> Input Monitoring`

После установки/обновления запускай копию из `/Applications`, чтобы не было конфликтов TCC между разными сборками.

## Если доступы сломались
Используй кнопку `Восстановить` в UI. Она:
1. сбрасывает `Accessibility` и `ListenEvent` для приложения;
2. открывает разделы `Универсальный доступ` и `Мониторинг ввода`;
3. перезапускает приложение.

Ручной сброс:
```bash
tccutil reset Accessibility com.klacapp.klac
tccutil reset ListenEvent com.klacapp.klac
```

## Что нового в 1.4.0
- Исправлен сценарий, когда `Тест звука` работает, а при реальной печати тишина.
- Добавлена явная проверка и индикация `Input Monitoring` в UI.
- Улучшен мастер восстановления доступов (сброс и открытие обоих разделов).
- Добавлена расширенная диагностика запуска захвата клавиатуры.
- Улучшен `Stack-режим`: контраст между `0%` и `100%` стал заметно выше.

## Что нового в 1.7.1
- Исправлена тихая громкость новых Mechvibes-паков (авто-подъем gain для тихих исходников).
- Добавлен fallback `keyUp` для Mechvibes-паков, чтобы релиз клавиш звучал полноценно.
- Добавлена сборка `drag-and-drop .dmg` с ярлыком `Applications` внутри образа.

## Что нового в 1.7.0
- Добавлены 4 встроенных профиля Mechvibes:
  - `Gateron Browns - Revolt`
  - `HyperX Aqua`
  - `Box Jade`
  - `Opera GX`
- Удалены старые встроенные профили, оставлен компактный набор под Mechvibes.
- Удалена функция самостоятельного импорта sound pack из UI.
- Добавлен build tag в версии приложения: формат `vX.Y.Z (bN-tag)`.
- Обновлен компактный liquid-glass UI: плотнее layout и выше читаемость в dark theme.

## Что нового в 1.6.0
- Добавлен профиль `Kalih Box White` в список встроенных sound packs.
- Добавлен режим `Авто-нормализация (inverse-кривая)` с целевым уровнем `@100%`.
- Добавлен ручной редактор кривой уровней с draggable-точками (`L/M/H`) вместо 6 слайдеров.
- Улучшена стабильность уровня в strict-режиме: отключены бустеры темпа/стака и уменьшен jitter.
- Исправлены хвосты задержки звука: очередь воспроизведения теперь принудительно срезается при переполнении.

## Что нового в 1.5.2
- Обновлен главный popover: более компактный liquid-glass интерфейс.
- Унифицирован стиль кнопок (`Проверить`, `Восстановить`, `?`, `шестеренка`, `power`).
- Улучшена читаемость: повышен контраст основного текста и кнопок.
- Убраны лишние подписи и пустые отступы, UI стал более лаконичным.
- Снижена фоновая CPU-нагрузка: таймеры опроса теперь активны только для включенных функций, уменьшены лишние обновления UI-метрик.
- Исправлено переключение аудиовыхода (динамики/наушники) без перезапуска приложения: граф `AVAudioEngine` пересобирается при смене устройства.

## Подпись приложения и стабильность TCC
По умолчанию сборка подписывается ad-hoc (`-`), из-за чего права могут периодически слетать.

Лучше использовать постоянную подпись:
```bash
security find-identity -v -p codesigning
SIGN_IDENTITY="Apple Development: YOUR_NAME (TEAMID)" ./scripts/build_app.sh --install
```

## Релизы в GitHub
```bash
cd "/path/to/project"
./scripts/release.sh v1.7.1
```

Что делает `release.sh`:
1. Собирает релизный `.app` в `dist/`.
2. Упаковывает архив `dist/*-vX.Y.Z.zip`.
3. Создает git tag.
4. Пушит `main` и tag.
5. Создает GitHub Release через `gh` и прикладывает zip.

Полезные флаги:
```bash
./scripts/release.sh v1.7.1 --dry-run
./scripts/release.sh v1.7.1 --notes-file RELEASE_NOTES.md
./scripts/release.sh v1.7.1 --skip-push
```

## Лицензия
Проект распространяется под GPL-3.0, см. файл `LICENSE`.

## Структура проекта
- `Sources/KlacApp/ContentView.swift` — UI и настройки
- `Sources/KlacApp/KeyboardSoundService.swift` — логика клавиш/аудио/TCC
- `Sources/KlacApp/AppDelegate.swift` — menu bar статус-элемент и popover
- `scripts/build_app.sh` — сборка `.app`
- `scripts/release.sh` — выпуск релизов в GitHub
